---
author: "Micaela Estrella"
date: "15 de Marzo de 2024"
title: "Aprendizaje de Máquinas 2024 L0"
output:
  html_document:
    df_print: paged
---

# Laboratorio 0: Regresión Lineal Múltiple

Este laboratorio se adentra en los fundamentos de la Regresión Lineal Múltiple, una técnica esencial que permite modelar la relación entre una variable dependiente y dos o más variables independientes simultáneamente. Para poder resolverlo se recomienda haber leído y comprendido previamente los siguientes documentos:

-   Intro a R.Rmd
-   Tidyverse y el Data Wrangling.Rmd
-   Iteración Funcional con Purrr.Rmd
-   Tutorial Regresión Simple.Rmd

En los siguientes ejercicios seguiremos usando el dataset gapminder presentado en el tutorial de Regresión Simple.
Por lo cual, en primer lugar lo importamos junto con las librerías que necesitaremos.

```{r}
install.packages("dplyr")
install.packages("gapminder")
```

Para comprobar la instalación y empezar conociendo nuestro dataset, imprimimos sus primeras filas.

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(gapminder)
library(dplyr)

gapminder %>% head()
```

## Ejercicio 1

Entrene un módelo de regresión lineal que estime la esperanza de vida de un país en el año 2002 teniendo en cuenta el continente y el gdpPercap. (Recuerde usar el logaritmo del gdp)

```{r}
# Obtenemos conjunto de datos reducido
data <- gapminder %>%
  filter(year == 2002) %>%
  # Añadimos una columna con el logaritmo de GDP
  mutate(logGdpPerCap = log(gdpPercap))

# Obtenemos el modelo de regresión lineal
model <- data %>% lm(formula = lifeExp ~ continent + logGdpPerCap)

summary(model)

```

#### Interpretación
"Estimate, Intercept" = 15.6162 --> Esto se interpreta como que toda persona tiene una experanza de vida de al menos 15 años
"Estimate, logGdpPerCap"= 5.1584 --> Esto significa que por cada punto logarítmico de PBI, una persona aumenta un año de experanza de vida.

Para observar la eficacia del en una gráfica bidimensional que nos permita comparar visualmente los datos reales con los de la predicción, 
filtramos nuestro dataset para quedarnos exclusivamente con uno de los continentes y lo graficamos a usando un modelo semejante para obtener una predicción. 

```{r}
# Filtrar conjunto de datos
data_america <- data %>% filter(continent == "Americas")

# Graficar datos
plot(
  lifeExp ~ logGdpPerCap,
  data = data_america,
  xlab = "GDP Per Capita",
  ylab = "Life Expectancy",
  main = "Americas Life Expectancy"
)

# Obtener predicción
model_america <- data_america %>% lm(formula = lifeExp ~ logGdpPerCap)
# Graficar
abline(model_america)
```

### ¿Generaría un mejor modelo si agregamos la población como una feature más? ¿En qué basa su respuesta?

Para determinar esto, generamos un modelo que adicione la población como feature y obtenemos un resumen de sus resultados.

``` {r}         
model_pop <- data %>% lm(formula = lifeExp ~ continent + logGdpPerCap + pop)
summary(model_pop)
```

**RTA:** Se observa en el resumen del modelo que incluye la población que el P value asociado a la población (pop) es alto (0.514118) y el
t value extremadamente pequeño (3.599e-09). Esto nos permite concluir que no se encontró relación entre la población y el PBI per cápita, o que esta 
no es suficientemente relevante para que pueda considerarse que el añadir la población como feature mejora el modelo.

## Ejercicio 2

Entrene un modelo de regresión lineal múltiple igual que el del ejercicio anterior para cada año del que se tiene información en el dataset. Alamcenar los valores de los coeficientes de todos los modelos en un dataframe que tenga las siguientes columnas:

![](img/tibble.png)

Debe realizar esta tarea en un único pipeline (usando %\>% y el paradigma funcional) definiendo todas las funciones necesarias.

```{r}
gapminder %>%
  # Add column with logarithms of each GDP per capita
  mutate(logGdpPerCap = log(gdpPercap)) %>%
  # Group rows by year
  group_by(year) %>%
  summarise(
    # This summarise parameter should be a dataframe so we convert it
    data.frame(as.list(
      # Create a linear model and get its coefficients
      lm(formula = lifeExp ~ logGdpPerCap + continent)$coefficients
    ))
  ) %>%
  # Sort by year
  arrange(year)

```

## Ejercicio 3

Entrene un modelo de regresión lineal simple para cada continente que estime
la esperanza de vida de un país en el año 2002 teniendo en cuenta el gdpPercap
y dibuje la recta correspondiente. Debe realizar esta tarea en un único pipeline
(usando %\>% y el paradigma funcional) definiendo todas las funciones necesarias.

Nota: les recomendamos usar la función split() para separar el dataset en una
lista de dataset según el continente.

```{r}
install.packages("purrr")
library(purrr)
```

```{r}
gapminder %>%
  # Remove all the rows whose year is distinct from 2002
  filter(year == 2002) %>%
  # Split table in five dataframes, one for each continent
  split(.$continent) %>%
  map(function(continent) {
    # Create a linear model
    model <- lm(formula = continent$lifeExp ~ continent$gdpPercap)
    # Plot real values
    plot(
      lifeExp ~ gdpPercap,
      data = continent,
      xlab = "GDP Per Capita",
      ylab = "Life Expectancy",
      # Get continent's name (e.g. America)
      main = continent[1]
    )
    # Plot Linear Model function over last plot
    abline(model, col = "red")
  })

```
