---
author: "Micaela Estrella"
date: "15 de Marzo de 2024"
title: "Aprendizaje de Máquinas 2024 L0"
output:
  html_document:
    df_print: paged
---

# Laboratorio 0: Regresión Lineal Múltiple

Este laboratorio se adentra en los fundamentos de la Regresión Lineal Múltiple, una técnica esencial que permite modelar la relación entre una variable dependiente y dos o más variables independientes simultáneamente. Para poder resolverlo se recomienda haber leído y comprendido previamente los siguientes documentos:

-   Intro a R.Rmd
-   Tidyverse y el Data Wrangling.Rmd
-   Iteración Funcional con Purrr.Rmd
-   Tutorial Regresión Simple.Rmd

En los siguientes ejercicios seguiremos usando el dataset gapminder presentado en el tutorial de Regresión Simple.

```{r}
install.packages("dplyr")
install.packages("gapminder")
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
library(gapminder)
library(dplyr)

gapminder %>% head()
```

## Ejercicio 1

Entrene un módelo de regresión lineal que estime la esperanza de vida de un país en el año 2002 teniendo en cuenta el continente y el gdpPercap. (Recuerde usar el logaritmo del gdp)

```{r}
# Obtenemos conjunto de datos reducido
data <- gapminder %>%
  filter(year == 2002) %>%
  # Usamos el logaritmo de GDP
  mutate(logGdpPerCap = log(gdpPercap))

# Obtenemos el modelo de regresión lineal
model <- data %>% lm(formula = lifeExp ~ continent + logGdpPerCap)

summary(model)

```

#### Interpretación

Estimate, Intercept: 15.6162 --> Toda persona tiene una experanza de vida de al menos 15 años

Estimate, logGdpPerCap: 5.1584 --> por cada punto logarítmico de PBI, una persona aumenta un año de experanza de vida.

Gráfica de la esperanza de vida para el continente americano respecto a su predicción:

```{r}
# Filtrar conjunto de datos
data_america <- data %>% filter(continent == "Americas")
# Graficar datos
plot(
  lifeExp ~ logGdpPerCap,
  data = data_america,
  xlab = "GDP Per Capita",
  ylab = "Life Expectancy",
  main = "Americas Life Expectancy"
)

# Obtener predicción
model_america <- data_america %>% lm(formula = lifeExp ~ logGdpPerCap)
# Graficar
abline(model_america)
```

¿Generaría un mejor modelo si agregamos la población como una feature más? ¿En qué basa su respuesta?

**RTA:** Tiene un P alto y un t chiquito (y no pone estrellitas al lado). Ergo, no mejora el modelo. Un p grande indica que es factible que la relación descubierta sea fruto del azar.

``` {r}         
model_pop <- data %>% lm(formula = lifeExp ~ continent + logGdpPerCap + pop)
summary(model_pop)
```

## Ejercicio 2

Entrene un modelo de regresión lineal múltiple igual que el del ejercicio anterior para cada año del que se tiene información en el dataset. Alamcenar los valores de los coeficientes de todos los modelos en un dataframe que tenga las siguientes columnas:

![](img/tibble.png)

Debe realizar esta tarea en un único pipeline (usando %\>% y el paradigma funcional) definiendo todas las funciones necesarias.

```{r}
gapminder %>%
  # Add column with logarithms of each GDP per capita
  mutate(logGdpPerCap = log(gdpPercap)) %>%
  # Group by year
  group_by(year) %>%
  # It recieves a dataframe as argument and returns a new dataframe
  reframe(
    # Convert a list to dataframe
    data.frame(as.list(
    # Create a linear model and get its coefficients
      lm(formula = lifeExp ~ logGdpPerCap + continent)$coefficients
    ))
  ) %>%
  # Sort by year
  arrange(year)

```

## Ejercicio 3

Entrene un modelo de regresión lineal simple para cada continente que estime la esperanza de vida de un país en el año 2002 teniendo en cuenta el gdpPercap y dibuje la recta correspondiente. Debe realizar esta tarea en un único pipeline (usando %\>% y el paradigma funcional) definiendo todas las funciones necesarias.

Nota: les recomendamos usar la función split() para separar el dataset en una lista de dataset según el continente.

```{r}
install.packages("purrr")
library(purrr)
```

```{r}
gapminder %>%
  # Split table in five dataframes, one for each continent
  split(.$continent) %>%
  map(function(continent) {
    # Filter continent to only keep records from a certain year
    continent <- continent %>% filter(year == 2002)
    # Create a linear model
    model <- lm(formula = continent$lifeExp ~ continent$gdpPercap)
    # Plot real values
    plot(
      lifeExp ~ gdpPercap,
      data = continent,
      xlab = "GDP Per Capita",
      ylab = "Life Expectancy",
      # Get continent's name (e.g. America)
      main = continent[1]
    )
    # Plot Linear Model function over last plot
    abline(model, col = "red")
  })

```
